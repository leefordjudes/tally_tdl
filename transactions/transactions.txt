[System: Formula]
	VchTypeMappedFlt: NOT $$IsEmpty:$APTallyName	

[System: Variables]
	Variable : TxnVchFromDate 	: String	
	Variable : TxnVchToDate 	: String	
	Variable : TxnVchTypeId		: Number
	Variable : TxnVchTypeName	: String
	
	LIST VARIABLE 	: Ledger Map List 	: String
	LIST VARIABLE 	: Ledger Add List 	: String
	
	LIST VARIABLE 	: StockItem Map List 	: String
	LIST VARIABLE 	: StockItem Add List 	: String
	
	LIST VARIABLE 	: VoucherType Map List 	: String
	
	
	
[Report: APSaveVoucher]
	Object: Company: ##SVCurrentCompany
	Form: APSaveVoucher
	
[Form: APSaveVoucher]
	Part: APSaveVoucher
	Buttons: APSaveVoucherFn
	Height: 100% screen
	Width: 100% screen
	
[Part: APSaveVoucher]
	Line: APSaveVoucher
	Repeat: APSaveVoucher: APVoucherTypesMapped
	Scroll: Vertical
	
	[Line: APSaveVoucher]
		Field: VchTypeId, VchTypeName
		
		[Field: VchTypeId]
			Set as: $ApId
			
		[Field: VchTypeName]
			Set as: $ApTallyName

	
[Button: APSaveVoucherFn]
	Key: F4
	Action: Call : APSaveVoucher
	Title: "Download Voucher"		
	
[Collection: APVoucherTypesMapped]
	Use			: APVoucherTypes
	Filter		: VchTypeMappedFlt
	Title		: "Mapped Voucher Types"	
	Format		: $APId, 5	
	Format		: $APTallyName, 20
	
	
[Function: APSaveVoucher]
;	Variable: VTypeIdVar: Number
;	Variable: VTypeNameVar: String
	
;	Local Formula: Lc1: $$ListCount:LedgerMapList
;	Local Formula: Lc2: $$ListCount:StockItemMapList
	Local Formula: VtypName: ##VoucherTypeMapList[$$ListIndex:VoucherTypeMapList:##TxnVchTypeId]

;100: Set Object: (Company, ##SVCurrentCompany). 	;;=> commented here
;200: LIST FILL : Ledger Map List : APLedgers : $APId : $APTallyName
;lc1: Msg Box: "lc1":@Lc1
;201: LIST FILL : StockItem Map List : APStockItems : $APHsnCode : $APTallyName
;lc2: Msg Box: "lc2":@Lc2
;300: Walk Collection: APVoucherTypesMapped			;;=> Shows Error as (Memory access voilation)
;	400: Set: VTypeIdVar	: $APId
;	500: Set: VTypeNameVar	: $APTallyName	

;	501: Msg Box: $APId:$APTallyName		
	550: Msg Box: "vchtype": @VtypName
;	551: Set: VTypeIdVar	: ##TxnVchTypeId
;	552: Set: VTypeNameVar	: "Sales";##TxnVchTypeName
	600: Walk Collection: TallyExportVoucher Data Source
;		700: Walk Collection: data		
			701: Msg Box: $id:$voucher_no	
			800: call : APSaveEachVoucher
;		900: End Walk	
	1000: End Walk
	1100 : Call: AP Update Map
	1101: Msg Box: "Voucher Created":"Success"
;1300: End Walk


[Collection: TallyExportVoucher Data Source]
	Data Source		: HTTP JSON: @@APHost: UTF8
	JSON Object Path: "data:1"
	RemoteRequest	: TallyExportVoucher Rpc Request: UTF8
	Export Header	: "organization:" + @@APOrganization
	Export Header	: "auth_token:" + @@APAuthToken	
;;----------------------------RPC Request Start---------------------	
[Report: TallyExportVoucher Rpc Request]
	Form: TallyExportVoucher Rpc Request
	Plain JSON: Yes
		
[Form: TallyExportVoucher Rpc Request]
	Delete: XMLTag
	Full Object: Yes
	Belongs To: Yes
	Part: TallyExportVoucher Rpc Request Method, TallyExportVoucher Rpc Request Data
	
[Part: TallyExportVoucher Rpc Request Method]
	Line: TallyExportVoucher Rpc Request Method
	Scroll: Vertical
	
	[Line: TallyExportVoucher Rpc Request Method]
		Field: TallyExportVoucher Rpc Request Method
			
			[Field: TallyExportVoucher Rpc Request Method]
				Use: Name Field
				JSONTag: "method"
				Set as: "tally_export_voucher"
				
[Part: TallyExportVoucher Rpc Request Data]
	Line: TallyExportVoucher Request Data
	JSONTag: "data"
	Scroll: Vertical

	[Line: TallyExportVoucher Request Data]
		Field: TallyExportVoucher Request From Date
		Field: TallyExportVoucher Request To Date
		Field: TallyExportVoucher Request Voucher Type Id
			
			[Field: TallyExportVoucher Request From Date]
				Type: String
				JSONTag: "from_date"	
				Set as: ##TxnVchFromDate
			[Field: TallyExportVoucher Request To Date]
				Type: String
				JSONTag: "to_date"
				Set as: ##TxnVchFromDate
				
			[Field: TallyExportVoucher Request Voucher Type Id]
				Type: Number
				JSONTag: "voucher_type_id"
				Set as: ##TxnVchTypeId				
;;----------------------------RPC Request End---------------------	

[Function: GetPartyGstRegistrationType]
		Parameter	: RegType	: String
		Variable	: Out		: String
		Returns		: String		

	1: If: ##RegType = "UNREGISTERED"
	2:  Set: Out: "Unregistered/Consumer"	
	3: End If
	4: If: ##RegType = "REGULAR"
	5:  Set: Out: "Regular"
	6: End If
	7: Return: ##Out
		

[Variable: AP Master Map]
	Variable: Id			: Number
	Variable: TallyName		: String

[Function: APSaveEachVoucher]
	Variable: IdVar				:	Number
	Variable: TallyNameVar		:	String
	Variable: TallyStockItemVar	:	String
	Variable: MapItemTypeVar 	: 	String
	Variable: ListIdxVar		: 	Number
	
	Variable: HsnCodeVar		: 	String	
	Variable: GstRegTypeVar		: 	String

	
	List Variable: LedgerToSaveVar: Ap Master Map 
	
	Local Formula: PartyGstRegType: $$GetPartyGstRegistrationType:##GstRegTypeVar
	Local Formula: Lc: $$ListCount:LedgerMapList
	
	Local Formula: rate: $rate
	Local Formula: qty: $qty * -1		
	
;	m1: Msg Box: "step":"m1"
	100 : SET        	: SVViewName 			: $$SysName:InvVchView
	200	: NEW OBJECT 	: Voucher	
	300	: SET VALUE 	: Date 					: $date	
;	300b: Set: VTypeNameVar: ##VoucherTypeMapList[$$ListIndex:VoucherTypeMapList:##TxnVchTypeId]  		
	400	: SET VALUE 	: VoucherTypeName 		: ##VoucherTypeMapList[$$ListIndex:VoucherTypeMapList:##TxnVchTypeId]
;	400	: SET VALUE 	: VoucherTypeName 		: ##VTypeNameVar
;	500	: SET VALUE 	: VoucherNumber			: $voucher_no
;	600 : SET VALUE 	: PartyLedgerName 		: "Cash" 	;; get it from first item of ac txn
	600 : SET VALUE 	: PartyLedgerName 		: $party_name
	601: SET VALUE 	: IsInvoice 			: No
	610: If: $mode = "INVENTORY"
	620: 	SET VALUE 	: IsInvoice 			: Yes	
	650: End If
	710: If: Not $$IsEmpty:$ref_no
		720: 	SET VALUE 	: Reference			: $ref_no	
	730: End If 
	800: SET VALUE 	: GstRegistrationType		: "Unregistered/Consumer"
	900: If:  Not $$IsEmpty:$gst_reg_type
		910:  	SET		    : GstRegTypeVar			: $gst_reg_type	
		920: 	SET VALUE 	: GstRegistrationType	: @PartyGstRegType
	930: End If	 	
	931: If: NOt $$IsEmpty:$gst_no
		932: Set Value	: PartyGstIn			: $gst_no
	933: End If
;	1000 : SET VALUE 	: BasicBuyerName 		: "Cash"	;; get it from first item of ac txn
	1000 : SET VALUE 	: BasicBuyerName		: $party_name	
	1100 : SET VALUE 	: PartyMailingName		: $party_name
	1200 : SET VALUE 	: StateName				: @@GetCompanyStateName
	1300 : SET VALUE 	: CountryOfResidence	: @@GetCompanyCountryName
	1310 : If: Not $$IsEmpty:$gst_location
		1320: 	SET VALUE 	: PlaceOfSupply			: $gst_location
	1330 : Else	
		1340 : SET VALUE 	: PlaceOfSupply			: @@GetCompanyStateName
	1350 : End If
;	m2: Msg Box: "step":"m2"
	1600 : Walk Collection: ac_trns
		1700: Set: IdVar: $account_id  	
		1800: Set: ListIdxVar: $$ListIndex:LedgerMapList:##IdVar
		1900: Set: TallyNameVar: ##LedgerMapList[##ListIdxVar]  		
		2000: If: $$IsEmpty:##TallyNameVar 
			2100: Set: MapItemTypeVar : "Ledger"
			2200: Alter: AP Map Tally Name
			2300: If: Not $$IsEmpty:##TallyNameVar
				2400: Set: LedgerMapList[##ListIdxVar]: ##TallyNameVar
				2500: List Add:LedgerAddList:##IdVar:##TallyNameVar
			2600: End if
		2700: End If
		2701: Set: HsnCodeVar: $hsn_code

		2703: If: $$IsEmpty:##HsnCodeVar		
			2800: INSERT COLLECTION OBJECT 		: LEDGERENTRIES
			2900: SET VALUE 	: LedgerName 		: ##TallyNameVar
			3000: SET VALUE 	: IsDeemedPositive 	: if $amount > 0 then Yes else No
			3100: SET VALUE 	: Amount 			: $$AsAmount:$amount * -1 
			3200: SET TARGET 	: ..					
		3400: Else				
			1800a: Set: ListIdxVar: $$ListIndex:StockItemMapList:##HsnCodeVar
			1900a: Set: TallyStockItemVar: ##StockItemMapList[##ListIdxVar]  		
			2000a: If: $$IsEmpty:##TallyStockItemVar 
				2100a: Set: MapItemTypeVar : "StockItem"
				2200a: Alter: AP Map Tally Name
				2300a: If: Not $$IsEmpty:##TallyStockItemVar
					2400a: Set: StockItemMapList[##ListIdxVar]: ##TallyStockItemVar
					2500a: List Add:StockItemAddList:##HsnCodeVar:##TallyStockItemVar
				2600a: End if
			2700a: End If

			3600: INSERT COLLECTION OBJECT 			: INVENTORYENTRIES
			3700: SET VALUE 	: StockItemName 	: ##TallyStockItemVar
			3800: SET VALUE 	: IsDeemedPositive 	: No
			3900: SET VALUE 	: ActualQty 		: ($$TgtObject:$$AsQty:@qty)
			4000: SET VALUE 	: BilledQty 		: ($$TgtObject:$$AsQty:@qty)
			4100: SET VALUE 	: Rate 				: ($$TgtObject:$$AsRate:@rate)
			4200: SET VALUE 	: Amount 			: $$AsAmount:$taxable_amount
			4300: SET VALUE 	: GstHsnName		: $hsn_code
			4400: Set Value		: GstHsnInferApplicability : "Specify Details Here"
			4500: Set Value		: GstRateInferApplicability : "Specify Details Here"
			4600: Set Value		: GstOvrdnTaxability : "Taxable"			
			4800: INSERT COLLECTION OBJECT 			: ACCOUNTING ALLOCATIONS
			4900: SET VALUE 	: LedgerName 		: ##TallyNameVar
			5000: SET VALUE 	: IsDeemedPositive 	: No
			5100: SET VALUE 	: Amount 			: $$AsAmount:$amount * -1
			5200: SET TARGET 	: ..
			5300: Insert Collection Object: RATEDETAILS
			5400: Set Value: GSTRATEDUTYHEAD : "CGST"
			5500: Set Value: GSTRATEVALUATIONTYPE : "Based on Value"			
			5600: Set Value: GSTRATE: ($tax_ratio / 2)
			5700: Set Target: ..
			5800: Insert Collection Object: RATEDETAILS
			5900: Set Value: GSTRATEDUTYHEAD : "SGST/UTGST"
			6000: Set Value: GSTRATEVALUATIONTYPE : "Based on Value"			
			6100: Set Value: GSTRATE: ($tax_ratio / 2)
			6200: Set Target: ..	
			6300: Insert Collection Object: RATEDETAILS
			6400: Set Value: GSTRATEDUTYHEAD : "IGST"
			6500: Set Value: GSTRATEVALUATIONTYPE : "Based on Value"			
			6600: Set Value: GSTRATE: $tax_ratio
			6700: Set Target: ..		
			6800: Insert Collection Object: RATEDETAILS
			6900: Set Value: GSTRATEDUTYHEAD : "CESS"
			7000: Set Value: GSTRATEVALUATIONTYPE : $$SysName:NotApplicable			
			7100: Set Target: ..		
			7200: Insert Collection Object: RATEDETAILS
			7300: Set Value: GSTRATEDUTYHEAD : "STATE CESS"
			7400: Set Value: GSTRATEVALUATIONTYPE : "Based on Value"			
			7500: Set Target: ...

		7600: End If
		7700: Set: HsnCodeVar:""
	8000: End Walk

	20000: SET VALUE   	: PersistedView 	: ##SVViewName
	20100: CREATE TARGET
	
	
	
	
[Function: AP Update Map]
	Variable: LpIdx: Number: 1
	
	1: set Object: (company, ##svcurrentcompany).
	2: set target
	3: Walk Collection: ApLedgers				
		5: If: $$ListFind:LedgerAddList:$$String:$ApId			
			6: Set Target: APLedgers[##LpIdx]
			7: Set Value: ApTallyName: ##LedgerAddList[$$ListIndex:LedgerAddList:$$String:$ApId]
			8: Set Target: ..			
		9: end if		
		5a: Increment: LpIdx
	10: End Walk
	11: Set: LpIdx: 1
	12: Walk Collection: APStockItems
		13: If: $$ListFind:StockItemAddList:$ApHsnCode
			14: Set Target: APStockItems[##LpIdx]
			15: Set Value: ApTallyName: ##StockItemAddList[$$ListIndex:StockItemAddList:$ApHsnCode]
			16: Set Target: ..			
		17: end if		
		18: Increment: LpIdx
	19: End Walk
	20: alter target

[Function: AP Map Tally Name Submit]		
001: If: ##MapItemTypeVar = "Ledger"
	002: Set: TallyNameVar:#APMapTallyName
003: Else
	004: Set: TallyStockItemVar:#APMapTallyName
005: End If
	

[Report: AP Map Tally Name]
	Form: AP Map Tally Name
	
[Form: Ap Map Tally Name]
	Parts: Form SubTitle, AP Map Info
	No Confirm	: Yes
	FullWidth   : No
	Space Left	: 2
	Space Right	: 2
	On: Form Accept: Yes: Call: AP Map Tally Name Submit
	Local       : Field : Form SubTitle : Info  : $$LocaleString:"Map Information for " + ##MapItemTypeVar

[Part: AP Map Info]
	Option: AP Map Ledger Info 		: ##MapItemTypeVar = "Ledger"
	Option: AP Map Stock Item Info 	: ##MapItemTypeVar = "StockItem"
	
[!Part: AP Map Ledger Info]
	Use: Ap Map Info 1
	
[!Part: AP Map Stock Item Info]
	Use: Ap Map Info 1
	ObjectEx: (Company, ##SVCurrentCompany).ApStockItems[1, $APHsnCode=##HsnCodeVar]
	
	Local: Line: AP Map Info Line 1 : Local	:	Field	:	Medium Prompt	: Info		: "Hsn Code"
	Local: Line: AP Map Info Line 1 : Local	:	Field	:	Name Field		: Info		: $APHsnCode
	Local: Line: AP Map Info Line 2 : Local	:	Field	:	Medium Prompt	: Info		: "Description"
	Local: Line: AP Map Info Line 2 : Local	:	Field	:	Name Field		: Info		: $APName
	
[Part: Ap Map Info1]
	Lines: Ap Map Info Line 1, Ap Map Info Line 2, AP Map Info Line3
	ObjectEx: (Company, ##SVCurrentCompany).ApLedgers[1, $APId=##IdVar]
		
	[Line: AP Map Info Line 1]
		Fields: Medium Prompt, Name Field
		Space Bottom	: 0.4
		Local	:	Field	:	Medium Prompt	: Info		: "Ledger Name"
		Local	:	Field	:	Name Field		: Info		: $APName
		
			
	[Line: AP Map Info Line 2]
		Fields: Medium Prompt, Name Field
		Space Bottom	: 0.4
		Local	:	Field	:	Medium Prompt	: Info		: "Ledger Type"
		Local	:	Field	:	Name Field 		: Info		: $APAccountType
		
	[Line: AP Map Info Line 3]
		Fields: Medium Prompt, Ap Map Tally Name
		Space Bottom	: 0.4
		Local	:	Field	:	Medium Prompt	: Info		: "Tally Name"
		
		[Field: AP Map Tally Name]
			Use: NameField 			
			Option: AP Map Tally Ledger Name : ##MapItemTypeVar = "Ledger"
			Option: AP Map Tally Unit Name : ##MapItemTypeVar = "Unit"
			Option: AP Map Tally StockItem Name : ##MapItemTypeVar = "StockItem"
			
			
		[!Field: AP Map Tally Ledger Name]
			Use: NameField
			Table: TallyLedgers,NotApplicable
			Show Table: Always
			Add: Key: Create Ledger
			
		[!Field: AP Map Tally Unit Name]
			Use: NameField
			Table: TallyUnits,NotApplicable
			Show Table: Always
			
		[!Field: AP Map Tally Stock Item Name]
			Use: NameField
			Table: TallyStockItems,NotApplicable
			Show Table: Always
			Add: Key: Create Stock Item
			


















	
	